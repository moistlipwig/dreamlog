app:
  # Frontend URL for OAuth2 redirects
  # Dev: http://localhost:4200 | Production: leave empty or set to your domain
  frontend:
    url: ${FRONTEND_URL:http://localhost:4200}
    # Path to redirect after successful OAuth2 login
    oauth-success-path: /app

spring:
  application:
    name: dreamlog
  datasource:
    url: jdbc:postgresql://localhost:5432/dreamlog
    username: dream
    password: dream
  jpa:
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
  flyway:
    enabled: true
    locations: classpath:db/migration
    url: ${spring.datasource.url}
    user: ${spring.datasource.username}
    password: ${spring.datasource.password}
  security:
    oauth2:
      client:
        registration:
          google:
            # REQUIRED: Set via environment variables or application-local.yml
            # See OAUTH_SETUP.md for configuration instructions
            client-id: ${GOOGLE_CLIENT_ID:REPLACE_WITH_ACTUAL_GOOGLE_CLIENT_ID}
            client-secret: ${GOOGLE_CLIENT_SECRET:REPLACE_WITH_ACTUAL_GOOGLE_CLIENT_SECRET}
            scope:
              - openid  # Required for OpenID Connect (MUST be lowercase)
              - email
              - profile
          facebook:
            # OPTIONAL: Only if you want Facebook login
            client-id: ${FACEBOOK_CLIENT_ID:REPLACE_WITH_ACTUAL_FACEBOOK_APP_ID}
            client-secret: ${FACEBOOK_CLIENT_SECRET:REPLACE_WITH_ACTUAL_FACEBOOK_APP_SECRET}
            scope:
              - email
              - public_profile
  # Spring AI with Google AI Studio (OpenAI-compatible endpoint)
  ai:
    openai:
      api-key: ${GOOGLE_AI_API_KEY}
      base-url: https://generativelanguage.googleapis.com/v1beta/openai
      chat:
        options:
          model: gemini-2.5-flash
          temperature: 0.7

# Google AI Studio native API (for image generation)
google:
  ai:
    api-key: ${GOOGLE_AI_API_KEY}
    base-url: https://generativelanguage.googleapis.com/v1beta
    # Model for text analysis
    text-model: gemini-2.5-flash
    # Model for image generation (retires Oct 31, 2025 - migrate to gemini-2.5-flash-image)
    image-model: gemini-2.0-flash-preview-image-generation

server:
  servlet:
    session:
      cookie:
        # Security: SameSite=Lax prevents CSRF while allowing normal navigation
        same-site: lax
        # HttpOnly is set by Spring Security automatically
        http-only: true
        # Secure in production (HTTPS), false in dev
        secure: false

management:
  endpoints:
    web:
      exposure:
        include: health
  endpoint:
    health:
      show-details: always

# MinIO Configuration (S3-compatible object storage)
minio:
  endpoint: ${MINIO_ENDPOINT:http://localhost:9000}
  access-key: ${MINIO_ACCESS_KEY:minioadmin}
  secret-key: ${MINIO_SECRET_KEY:minioadmin}
  bucket-name: dreamlog-images
  # Pre-signed URL validity (2 hours)
  url-expiry-seconds: 7200


# db-scheduler Configuration
db-scheduler:
  enabled: true
  table-name: scheduled_tasks
  immediate-execution-enabled: true
  # Polling interval for checking scheduled tasks
  polling-interval: 30s
  # Thread pool size for task execution
  threads: 5
  # Heartbeat interval for detecting dead executors
  heartbeat-interval: 5m

# Resilience4j Configuration
resilience4j:
  circuitbreaker:
    instances:
      googleAi:
        # Open circuit after 5 consecutive failures
        failure-rate-threshold: 50
        # Wait 1 minute before transitioning to half-open
        wait-duration-in-open-state: 60s
        # Allow 3 test calls in half-open state
        permitted-number-of-calls-in-half-open-state: 3
        # Track last 10 calls for failure rate calculation
        sliding-window-size: 10
        sliding-window-type: COUNT_BASED
  retry:
    instances:
      googleAi:
        # Retry 3 times with exponential backoff
        max-attempts: 3
        wait-duration: 2s
        exponential-backoff-multiplier: 2
        # Retry on specific exceptions
        retry-exceptions:
          - java.io.IOException
          - java.net.SocketTimeoutException
  ratelimiter:
    instances:
      googleAi:
        # Limit to 10 requests per second
        limit-for-period: 10
        limit-refresh-period: 1s
        timeout-duration: 0s
