<div class="dashboard-container">
  <!-- Header with greeting and quick actions -->
  <div class="dashboard-header">
    <div class="header-content">
      <div class="welcome-text">
        <h1>Welcome back{{ user() ? ', ' + user()!.name : '' }}! üëã</h1>
        <p>Ready to log today's dream?</p>
      </div>
      <div class="quick-actions">
        <a mat-raised-button class="btn-primary" routerLink="/app/dreams/new">
          <mat-icon>add</mat-icon>
          New Dream
        </a>
      </div>
    </div>
  </div>

  @if (isLoading()) {
    <!-- Loading state -->
    <div class="dashboard-grid">
      <mat-card class="p-4 animate-pulse">
        <div class="h-32 bg-gray-200 rounded"></div>
      </mat-card>
      <mat-card class="p-4 animate-pulse">
        <div class="h-32 bg-gray-200 rounded"></div>
      </mat-card>
    </div>
  } @else if (error()) {
    <!-- Error state -->
    <mat-card class="p-6 text-center">
      <mat-icon class="text-red-500 text-5xl mb-4">error_outline</mat-icon>
      <p class="text-red-600">{{ error() }}</p>
      <button mat-raised-button color="primary" class="mt-4" (click)="loadDashboardData()">
        Retry
      </button>
    </mat-card>
  } @else {
    <!-- Two Column Dashboard Grid -->
    <div class="dashboard-grid">
      <!-- Left Column: Recent Dreams -->
      <div class="recent-dreams-section">
        <!-- Header Toolbar: Title | Search | View All in one line -->
        <div class="section-header-toolbar">
          <h2>{{ searchVm().isSearching ? 'Search Results' : 'Recent Dreams' }}</h2>
          <div class="header-search">
            <app-search-bar></app-search-bar>
          </div>
          <a mat-button routerLink="/app/dreams" class="view-all-link">
            View All
            <mat-icon>arrow_forward</mat-icon>
          </a>
        </div>

        @if (displayDreams().length === 0 && !searchVm().isSearching) {
          <!-- Empty state -->
          <mat-card class="p-8 text-center">
            <mat-icon class="text-gray-400 text-6xl mb-4">psychology_alt</mat-icon>
            <p class="text-gray-600 text-lg mb-4">No dreams yet</p>
            <p class="text-gray-500 mb-6">Start your dream journaling journey today!</p>
            <a mat-raised-button color="primary" routerLink="/app/dreams/new">
              <mat-icon>add</mat-icon>
              Add Your First Dream
            </a>
          </mat-card>
        } @else if (displayDreams().length === 0 && searchVm().isSearching) {
          <!-- No search results -->
          <mat-card class="p-8 text-center">
            <mat-icon class="text-gray-400 text-6xl mb-4">search_off</mat-icon>
            <p class="text-gray-600 text-lg mb-2">No dreams found</p>
            <p class="text-gray-500">Try a different search term</p>
          </mat-card>
        } @else {
          <!-- Dreams list -->
          <div class="dreams-list">
            @for (dream of displayDreams(); track dream.id) {
              <mat-card class="dream-card" [routerLink]="['/app/dreams', dream.id]">
                <div class="dream-header">
                  <div class="dream-info">
                    <h3 class="dream-title">{{ dream.title }}</h3>
                    <p class="dream-date">{{ dream.date | date }}</p>
                  </div>
                  <div class="dream-mood">
                    {{ getMoodEmoji(dream.moodInDream) }}
                  </div>
                </div>
                <mat-card-content>
                  <p class="dream-content">
                    {{ dream.content.substring(0, 150)
                    }}{{ dream.content.length > 150 ? '...' : '' }}
                  </p>
                  @if (dream.tags && dream.tags.length > 0) {
                    <div class="dream-tags">
                      @for (tag of dream.tags.slice(0, 3); track tag) {
                        <span class="tag">{{ tag }}</span>
                      }
                      @if (dream.tags.length > 3) {
                        <span class="tag tag-more">+{{ dream.tags.length - 3 }} more</span>
                      }
                    </div>
                  }
                </mat-card-content>
              </mat-card>
            }
          </div>
        }
      </div>

      <!-- Right Column: Stats Sidebar -->
      <div class="sidebar">
        <mat-card class="stats-card">
          <mat-card-header>
            <mat-card-title>Your Statistics</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="stats-grid">
              <!-- Total Dreams -->
              <div class="stat-mini-card">
                <div class="stat-header">
                  <span class="stat-label">Total Dreams</span>
                  <span class="stat-icon">üìù</span>
                </div>
                <p class="stat-value">{{ stats()?.totalDreams || 0 }}</p>
                <p class="stat-change">This month</p>
              </div>

              <!-- Streak -->
              <div class="stat-mini-card">
                <div class="stat-header">
                  <span class="stat-label">Day Streak</span>
                  <span class="stat-icon">üî•</span>
                </div>
                <p class="stat-value">{{ stats()?.streak || 0 }}</p>
                <p class="stat-change">Keep going!</p>
              </div>

              <!-- AI Analyses -->
              <div class="stat-mini-card">
                <div class="stat-header">
                  <span class="stat-label">AI Analyses</span>
                  <span class="stat-icon">ü§ñ</span>
                </div>
                <p class="stat-value">{{ stats()?.aiAnalyses || 0 }}</p>
                <p class="stat-change">Analyzed</p>
              </div>

              <!-- Most Common Mood -->
              <div class="stat-mini-card">
                <div class="stat-header">
                  <span class="stat-label">Common Mood</span>
                  <span class="stat-icon">{{ getMoodEmoji(stats()?.mostCommonMood) }}</span>
                </div>
                <p class="stat-value">{{ getMoodLabel(stats()?.mostCommonMood || null) }}</p>
                <p class="stat-change">Overall</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>
  }

  <!-- FAB: Add Dream (fixed position, right bottom corner) -->
  @if (!isLoading() && !error()) {
    <a mat-fab routerLink="/app/dreams/new" aria-label="Add new dream" class="fab-add-dream">
      <mat-icon>add</mat-icon>
    </a>
  }
</div>
